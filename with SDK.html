<!DOCTYPE html>
<html>
<head>
  <title>Saint Thomas English Medium School House Points System - Secure</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      text-align: center;
      background: linear-gradient(rgba(0,0,0,0.6), rgba(0,0,0,0.6)),
                  url("https://images.unsplash.com/photo-1523050854058-8df90110c9f1") no-repeat center center fixed;
      background-size: cover;
      color: white;
    }
    h2 { margin-top: 20px; font-size: 26px; text-shadow: 2px 2px 6px black; }
    h3 { margin-bottom: 15px; text-shadow: 1px 1px 5px black; }
    .page {
      background: rgba(255, 255, 255, 0.1);
      padding: 20px; margin: 20px auto; width: 90%; max-width: 600px;
      border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.4);
    }
    label { font-weight: bold; }
    input, select {
      padding: 8px; border-radius: 6px; border: none;
      margin: 5px 0; width: 200px; max-width: 100%; text-align: center;
    }
    button {
      margin: 5px; padding: 10px 16px; cursor: pointer; border: none;
      border-radius: 8px; font-weight: bold;
      background: linear-gradient(135deg, #4facfe, #00f2fe);
      color: white; box-shadow: 0 3px 6px rgba(0,0,0,0.3); transition: transform 0.2s;
    }
    button:hover { transform: scale(1.05); }
    .hidden { display: none; }
    .house-summary {
      border: 2px solid white; padding: 15px; margin: 10px 0;
      border-radius: 10px; background: rgba(255,255,255,0.15);
      box-shadow: 0 3px 8px rgba(0,0,0,0.3);
    }
    ul { text-align: left; margin: auto; width: 90%; list-style-type: none; padding: 0; }
    ul li {
      background: rgba(255,255,255,0.15); padding: 8px; margin: 5px 0;
      border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }
    @media print {
      body { margin: 0; background: white !important; color: black !important; }
      .no-print { display: none !important; }
      #dashboard { zoom: 0.75; width: 100% !important; page-break-inside: avoid; }
      canvas { max-width: 100% !important; height: auto !important; }
      @page { size: A4 portrait; margin: 10mm; }
    }
  </style>
</head>
<body>
  <h2>ğŸ« Saint Thomas English Medium School <br> House Points System </h2>

  <!-- Firebase SDK Setup -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getDatabase, ref, set, get, update, push, child } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAmRHUHJJqcJqoEdndx0c7lbZm0amci3mA",
      authDomain: "deepak-92e32.firebaseapp.com",
      databaseURL: "https://deepak-92e32-default-rtdb.firebaseio.com",
      projectId: "deepak-92e32",
      storageBucket: "deepak-92e32.firebasestorage.app",
      messagingSenderId: "593600019294",
      appId: "1:593600019294:web:a867b9f2a5eb09077dadcf"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // Global variables
    let users = {};
    let currentUser = null;
    let houses = {};
    let history = [];

    const defaultUsers = {
      "admin": { password: "admin123", role: "admin" },
      "pet1": { password: "pet111", role: "pet" },
      "pet2": { password: "pet222", role: "pet" },
      "pet3": { password: "pet333", role: "pet" }
    };

    const houseColors = {
      "Red": "#e74c3c",
      "Blue": "#3498db",
      "Green": "#2ecc71",
      "Yellow": "#f1c40f"
    };

    const ctx = document.createElement("canvas");
    ctx.id = "barChart";
    document.body.appendChild(ctx);

    let barChart;

    // ---- Firebase Functions ----
    async function saveData() {
      await set(ref(db, "houses"), houses);
      await set(ref(db, "history"), history);
      await set(ref(db, "users"), users);
    }

    async function loadData() {
      const housesSnap = await get(ref(db, "houses"));
      const historySnap = await get(ref(db, "history"));
      const usersSnap = await get(ref(db, "users"));

      houses = housesSnap.exists() ? housesSnap.val() : {
        "Red": { score: 0, gained: 0, lost: 0 },
        "Blue": { score: 0, gained: 0, lost: 0 },
        "Green": { score: 0, gained: 0, lost: 0 },
        "Yellow": { score: 0, gained: 0, lost: 0 }
      };

      history = historySnap.exists() ? historySnap.val() : [];
      users = usersSnap.exists() ? usersSnap.val() : defaultUsers;

      updateDashboard();
      document.getElementById("historyList").innerHTML =
        history.map(h => `<li>${h}</li>`).join("");
    }

    function logActivity(action, house, pts) {
      const now = new Date().toLocaleString();
      const msg = `[${now}] (${currentUser.name.toUpperCase()}) ${house} house ${action} ${pts} points. (Net: ${houses[house]?.score ?? "-"})`;
      history.unshift(msg);
      document.getElementById("historyList").innerHTML =
        history.map(h => `<li>${h}</li>`).join("");
      saveData();
    }

    function updateDashboard() {
      if (!barChart) {
        barChart = new Chart(document.getElementById("barChart"), {
          type: "bar",
          data: {
            labels: Object.keys(houses),
            datasets: [{
              label: "Net House Points",
              data: Object.values(houses).map(h => h.score),
              backgroundColor: Object.values(houseColors)
            }]
          },
          options: { responsive: true, plugins: { legend: { display: false } } }
        });
      } else {
        barChart.data.datasets[0].data = Object.values(houses).map(h => h.score);
        barChart.update();
      }

      let html = "";
      for (let [house, data] of Object.entries(houses)) {
        html += `
          <div class="house-summary">
            <h4 style="color:${houseColors[house]}">${house} House</h4>
            <p>âœ… Total Points Gained: <b>${data.gained}</b></p>
            <p>âŒ Total Points Lost: <b>${data.lost}</b></p>
            <p>ğŸ“Š Net Total: <b>${data.score}</b></p>
          </div>`;
      }

      let ranking = Object.entries(houses)
        .sort((a, b) => b[1].score - a[1].score)
        .map(([house, data], i) => `<p>${i+1}. <b style="color:${houseColors[house]}">${house}</b> - ${data.score}</p>`)
        .join("");

      html += `<div class="house-summary"><h4>ğŸ† Ranking</h4>${ranking}</div>`;
      document.getElementById("houseDetails").innerHTML = html;
    }

    // Expose functions to window (for buttons)
    window.loadData = loadData;
    window.saveData = saveData;
    window.logActivity = logActivity;
    window.updateDashboard = updateDashboard;

    // Load data at start
    loadData();
  </script>

  <!-- UI -->
  <div id="loginPage" class="page">
    <h3>ğŸ” Login</h3>
    <label>Username:</label><br>
    <input type="text" id="username"><br><br>
    <label>Password:</label><br>
    <input type="password" id="password"><br><br>
    <button onclick="login()">Login</button>
    <p id="loginMsg" style="color:yellow;"></p>
  </div>

  <div id="nav" class="hidden no-print">
    <button onclick="showPage('main')">â• Add/Deduct</button>
    <button onclick="showPage('history')">ğŸ“œ History</button>
    <button onclick="showPage('dashboard')">ğŸ“Š Dashboard</button>
    <button id="resetBtn" onclick="resetScores()" style="display:none;">â™» Reset Scores</button>
    <button id="adminPanelBtn" onclick="showPage('adminPanel')" style="display:none;">âš™ Admin Panel</button>
    <button class="no-print" onclick="exportHistory()">ğŸ’¾ Export History</button>
    <button onclick="logout()">ğŸšª Logout</button>
  </div>

  <div id="main" class="page hidden">
    <h3>Add or Deduct Points</h3>
    <label>Choose House: </label><br>
    <select id="houseSelect">
      <option value="Red">Red</option>
      <option value="Blue">Blue</option>
      <option value="Green">Green</option>
      <option value="Yellow">Yellow</option>
    </select><br><br>
    <label>Points: </label><br>
    <input type="number" id="points" value="10"><br><br>
    <button onclick="addPoints()">â• Add</button>
    <button onclick="deductPoints()">â– Deduct</button>
  </div>

  <div id="history" class="page hidden">
    <h3>ğŸ“œ Activity History</h3>
    <ul id="historyList"></ul>
  </div>

  <div id="dashboard" class="page hidden">
    <h3>ğŸ“Š Dashboard</h3>
    <button class="no-print" onclick="printDashboard()">ğŸ–¨ Print Dashboard</button>
    <br><br>
    <canvas id="barChart"></canvas>
    <div id="houseDetails"></div>
  </div>

  <div id="adminPanel" class="page hidden">
    <h3>âš™ Admin Panel</h3>
    <h4>ğŸ”‘ Change User Password</h4>
    <label>Username:</label><br>
    <input type="text" id="changeUser"><br>
    <label>New Password:</label><br>
    <input type="password" id="newPassword"><br>
    <button onclick="changePassword()">Change Password</button>
    <p id="adminMsg" style="color:yellow;"></p>
    <hr>
    <h4>â™» Reset All Passwords</h4>
    <button onclick="resetAllPasswords()">Reset to Default</button>
  </div>
</body>
</html>
